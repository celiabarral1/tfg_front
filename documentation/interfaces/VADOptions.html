<!doctype html>
<html class="no-js" lang="">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="x-ua-compatible" content="ie=edge">
        <title>frontend-web-emotions documentation</title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <link rel="icon" type="image/x-icon" href="../images/favicon.ico">
	   <link rel="stylesheet" href="../styles/style.css">
        <link rel="stylesheet" href="../styles/dark.css">
    </head>
    <body>
          <script>
               // Blocking script to avoid flickering dark mode
               // Dark mode toggle button
               var useDark = window.matchMedia('(prefers-color-scheme: dark)');
               var darkModeState = useDark.matches;
               var $darkModeToggleSwitchers = document.querySelectorAll('.dark-mode-switch input');
               var $darkModeToggles = document.querySelectorAll('.dark-mode-switch');
               var darkModeStateLocal = localStorage.getItem('compodoc_darkmode-state');

               function checkToggle(check) {
                    for (var i = 0; i < $darkModeToggleSwitchers.length; i++) {
                         $darkModeToggleSwitchers[i].checked = check;
                    }
               }

               function toggleDarkMode(state) {
                    if (window.localStorage) {
                         localStorage.setItem('compodoc_darkmode-state', state);
                    }

                    checkToggle(state);

                    const hasClass = document.body.classList.contains('dark');

                    if (state) {
                         for (var i = 0; i < $darkModeToggles.length; i++) {
                              $darkModeToggles[i].classList.add('dark');
                         }
                         if (!hasClass) {
                              document.body.classList.add('dark');
                         }
                    } else {
                         for (var i = 0; i < $darkModeToggles.length; i++) {
                              $darkModeToggles[i].classList.remove('dark');
                         }
                         if (hasClass) {
                              document.body.classList.remove('dark');
                         }
                    }
               }

               useDark.addEventListener('change', function (evt) {
                    toggleDarkMode(evt.matches);
               });
               if (darkModeStateLocal) {
                    darkModeState = darkModeStateLocal === 'true';
               }
               toggleDarkMode(darkModeState);
          </script>

        <div class="navbar navbar-default navbar-fixed-top d-md-none p-0">
               <div class="d-flex">
                    <a href="../" class="navbar-brand">frontend-web-emotions documentation</a>
                    <button type="button" class="btn btn-default btn-menu ion-ios-menu" id="btn-menu"></button>
               </div>
        </div>

        <div class="xs-menu menu" id="mobile-menu">
                <div id="book-search-input" role="search"><input type="text" placeholder="Type to search"></div>            <compodoc-menu></compodoc-menu>
        </div>

        <div class="container-fluid main">
           <div class="row main">
               <div class="d-none d-md-block menu">
                   <compodoc-menu mode="normal"></compodoc-menu>
               </div>
               <!-- START CONTENT -->
               <div class="content interface">
                   <div class="content-data">













<ol class="breadcrumb">
  <li class="breadcrumb-item">Interfaces</li>
  <li class="breadcrumb-item"
  >
  VADOptions</li>
</ol>

<ul class="nav nav-tabs" role="tablist">
        <li class="nav-item">
            <a href="#info" 
                class="nav-link"
                class="nav-link active"
                role="tab" id="info-tab" data-bs-toggle="tab" data-link="info">Info</a>
        </li>
        <li class="nav-item">
            <a href="#source" 
                class="nav-link"
                
                role="tab" id="source-tab" data-bs-toggle="tab" data-link="source">Source</a>
        </li>
</ul>

<div class="tab-content">
    <div class="tab-pane fade active in" id="info">
        <p class="comment">
            <h3>File</h3>
        </p>
        <p class="comment">
            <code>src/app/@core/common/utils/vad.ts/vad.ts</code>
        </p>




        <section data-compodoc="block-index">
            <h3 id="index">Index</h3>
            <table class="table table-sm table-bordered index-table">
                <tbody>
                    <tr>
                        <td class="col-md-4">
                            <h6><b>Properties</b></h6>
                        </td>
                    </tr>
                    <tr>
                        <td class="col-md-4">
                            <ul class="index-list">
                                <li>
                                            <span class="modifier">Optional</span>
                                        <a href="#bufferLen" 
>
                                            bufferLen
                                        </a>
                                </li>
                                <li>
                                            <span class="modifier">Optional</span>
                                        <a href="#context" 
>
                                            context
                                        </a>
                                </li>
                                <li>
                                            <span class="modifier">Optional</span>
                                        <a href="#energy_integration" 
>
                                            energy_integration
                                        </a>
                                </li>
                                <li>
                                            <span class="modifier">Optional</span>
                                        <a href="#energy_offset" 
>
                                            energy_offset
                                        </a>
                                </li>
                                <li>
                                            <span class="modifier">Optional</span>
                                        <a href="#energy_threshold_ratio_neg" 
>
                                            energy_threshold_ratio_neg
                                        </a>
                                </li>
                                <li>
                                            <span class="modifier">Optional</span>
                                        <a href="#energy_threshold_ratio_pos" 
>
                                            energy_threshold_ratio_pos
                                        </a>
                                </li>
                                <li>
                                            <span class="modifier">Optional</span>
                                        <a href="#fftSize" 
>
                                            fftSize
                                        </a>
                                </li>
                                <li>
                                            <span class="modifier">Optional</span>
                                        <a href="#filter" 
>
                                            filter
                                        </a>
                                </li>
                                <li>
                                            <span class="modifier">Optional</span>
                                        <a href="#smoothingTimeConstant" 
>
                                            smoothingTimeConstant
                                        </a>
                                </li>
                                <li>
                                        <a href="#source" 
>
                                            source
                                        </a>
                                </li>
                                <li>
                                            <span class="modifier">Optional</span>
                                        <a href="#voice_start" 
>
                                            voice_start
                                        </a>
                                </li>
                                <li>
                                            <span class="modifier">Optional</span>
                                        <a href="#voice_stop" 
>
                                            voice_stop
                                        </a>
                                </li>
                                <li>
                                            <span class="modifier">Optional</span>
                                        <a href="#voice_stop_delay" 
>
                                            voice_stop_delay
                                        </a>
                                </li>
                                <li>
                                            <span class="modifier">Optional</span>
                                        <a href="#voice_timeout" 
>
                                            voice_timeout
                                        </a>
                                </li>
                                <li>
                                            <span class="modifier">Optional</span>
                                        <a href="#voice_timeout_callback" 
>
                                            voice_timeout_callback
                                        </a>
                                </li>
                            </ul>
                        </td>
                    </tr>
                </tbody>
            </table>
        </section>



            <section data-compodoc="block-properties">
                <h3 id="inputs">Properties</h3>
                    <table class="table table-sm table-bordered">
                        <tbody>
                                <tr>
                                    <td class="col-md-4">
                                        <a name="bufferLen"></a>
                                        <span class="name "><b>bufferLen</b>
                                            <a href="#bufferLen">
                                                <span class="icon ion-ios-link"></span>
                                            </a>
                                        </span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="col-md-4">
                                        <code>bufferLen:         <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/number" target="_blank" >number</a></code>
</code>
                                    </td>
                                </tr>


                                    <tr>
                                        <td class="col-md-4">
                                            <i>Type : </i>        <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/number" target="_blank" >number</a></code>

                                        </td>
                                    </tr>

                                    <tr>
                                        <td class="col-md-4">
                                            <i>Optional</i>
                                        </td>
                                    </tr>




                        </tbody>
                    </table>
                    <table class="table table-sm table-bordered">
                        <tbody>
                                <tr>
                                    <td class="col-md-4">
                                        <a name="context"></a>
                                        <span class="name "><b>context</b>
                                            <a href="#context">
                                                <span class="icon ion-ios-link"></span>
                                            </a>
                                        </span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="col-md-4">
                                        <code>context:     <code>AudioContext | null</code>
</code>
                                    </td>
                                </tr>


                                    <tr>
                                        <td class="col-md-4">
                                            <i>Type : </i>    <code>AudioContext | null</code>

                                        </td>
                                    </tr>

                                    <tr>
                                        <td class="col-md-4">
                                            <i>Optional</i>
                                        </td>
                                    </tr>




                        </tbody>
                    </table>
                    <table class="table table-sm table-bordered">
                        <tbody>
                                <tr>
                                    <td class="col-md-4">
                                        <a name="energy_integration"></a>
                                        <span class="name "><b>energy_integration</b>
                                            <a href="#energy_integration">
                                                <span class="icon ion-ios-link"></span>
                                            </a>
                                        </span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="col-md-4">
                                        <code>energy_integration:         <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/number" target="_blank" >number</a></code>
</code>
                                    </td>
                                </tr>


                                    <tr>
                                        <td class="col-md-4">
                                            <i>Type : </i>        <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/number" target="_blank" >number</a></code>

                                        </td>
                                    </tr>

                                    <tr>
                                        <td class="col-md-4">
                                            <i>Optional</i>
                                        </td>
                                    </tr>




                        </tbody>
                    </table>
                    <table class="table table-sm table-bordered">
                        <tbody>
                                <tr>
                                    <td class="col-md-4">
                                        <a name="energy_offset"></a>
                                        <span class="name "><b>energy_offset</b>
                                            <a href="#energy_offset">
                                                <span class="icon ion-ios-link"></span>
                                            </a>
                                        </span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="col-md-4">
                                        <code>energy_offset:         <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/number" target="_blank" >number</a></code>
</code>
                                    </td>
                                </tr>


                                    <tr>
                                        <td class="col-md-4">
                                            <i>Type : </i>        <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/number" target="_blank" >number</a></code>

                                        </td>
                                    </tr>

                                    <tr>
                                        <td class="col-md-4">
                                            <i>Optional</i>
                                        </td>
                                    </tr>




                        </tbody>
                    </table>
                    <table class="table table-sm table-bordered">
                        <tbody>
                                <tr>
                                    <td class="col-md-4">
                                        <a name="energy_threshold_ratio_neg"></a>
                                        <span class="name "><b>energy_threshold_ratio_neg</b>
                                            <a href="#energy_threshold_ratio_neg">
                                                <span class="icon ion-ios-link"></span>
                                            </a>
                                        </span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="col-md-4">
                                        <code>energy_threshold_ratio_neg:         <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/number" target="_blank" >number</a></code>
</code>
                                    </td>
                                </tr>


                                    <tr>
                                        <td class="col-md-4">
                                            <i>Type : </i>        <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/number" target="_blank" >number</a></code>

                                        </td>
                                    </tr>

                                    <tr>
                                        <td class="col-md-4">
                                            <i>Optional</i>
                                        </td>
                                    </tr>




                        </tbody>
                    </table>
                    <table class="table table-sm table-bordered">
                        <tbody>
                                <tr>
                                    <td class="col-md-4">
                                        <a name="energy_threshold_ratio_pos"></a>
                                        <span class="name "><b>energy_threshold_ratio_pos</b>
                                            <a href="#energy_threshold_ratio_pos">
                                                <span class="icon ion-ios-link"></span>
                                            </a>
                                        </span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="col-md-4">
                                        <code>energy_threshold_ratio_pos:         <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/number" target="_blank" >number</a></code>
</code>
                                    </td>
                                </tr>


                                    <tr>
                                        <td class="col-md-4">
                                            <i>Type : </i>        <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/number" target="_blank" >number</a></code>

                                        </td>
                                    </tr>

                                    <tr>
                                        <td class="col-md-4">
                                            <i>Optional</i>
                                        </td>
                                    </tr>




                        </tbody>
                    </table>
                    <table class="table table-sm table-bordered">
                        <tbody>
                                <tr>
                                    <td class="col-md-4">
                                        <a name="fftSize"></a>
                                        <span class="name "><b>fftSize</b>
                                            <a href="#fftSize">
                                                <span class="icon ion-ios-link"></span>
                                            </a>
                                        </span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="col-md-4">
                                        <code>fftSize:         <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/number" target="_blank" >number</a></code>
</code>
                                    </td>
                                </tr>


                                    <tr>
                                        <td class="col-md-4">
                                            <i>Type : </i>        <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/number" target="_blank" >number</a></code>

                                        </td>
                                    </tr>

                                    <tr>
                                        <td class="col-md-4">
                                            <i>Optional</i>
                                        </td>
                                    </tr>




                        </tbody>
                    </table>
                    <table class="table table-sm table-bordered">
                        <tbody>
                                <tr>
                                    <td class="col-md-4">
                                        <a name="filter"></a>
                                        <span class="name "><b>filter</b>
                                            <a href="#filter">
                                                <span class="icon ion-ios-link"></span>
                                            </a>
                                        </span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="col-md-4">
                                        <code>filter:     <code>literal type[]</code>
</code>
                                    </td>
                                </tr>


                                    <tr>
                                        <td class="col-md-4">
                                            <i>Type : </i>    <code>literal type[]</code>

                                        </td>
                                    </tr>

                                    <tr>
                                        <td class="col-md-4">
                                            <i>Optional</i>
                                        </td>
                                    </tr>




                        </tbody>
                    </table>
                    <table class="table table-sm table-bordered">
                        <tbody>
                                <tr>
                                    <td class="col-md-4">
                                        <a name="smoothingTimeConstant"></a>
                                        <span class="name "><b>smoothingTimeConstant</b>
                                            <a href="#smoothingTimeConstant">
                                                <span class="icon ion-ios-link"></span>
                                            </a>
                                        </span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="col-md-4">
                                        <code>smoothingTimeConstant:         <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/number" target="_blank" >number</a></code>
</code>
                                    </td>
                                </tr>


                                    <tr>
                                        <td class="col-md-4">
                                            <i>Type : </i>        <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/number" target="_blank" >number</a></code>

                                        </td>
                                    </tr>

                                    <tr>
                                        <td class="col-md-4">
                                            <i>Optional</i>
                                        </td>
                                    </tr>




                        </tbody>
                    </table>
                    <table class="table table-sm table-bordered">
                        <tbody>
                                <tr>
                                    <td class="col-md-4">
                                        <a name="source"></a>
                                        <span class="name "><b>source</b>
                                            <a href="#source">
                                                <span class="icon ion-ios-link"></span>
                                            </a>
                                        </span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="col-md-4">
                                        <code>source:     <code>AudioNode | null</code>
</code>
                                    </td>
                                </tr>


                                    <tr>
                                        <td class="col-md-4">
                                            <i>Type : </i>    <code>AudioNode | null</code>

                                        </td>
                                    </tr>





                        </tbody>
                    </table>
                    <table class="table table-sm table-bordered">
                        <tbody>
                                <tr>
                                    <td class="col-md-4">
                                        <a name="voice_start"></a>
                                        <span class="name "><b>voice_start</b>
                                            <a href="#voice_start">
                                                <span class="icon ion-ios-link"></span>
                                            </a>
                                        </span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="col-md-4">
                                        <code>voice_start:         <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/function" target="_blank" >function</a></code>
</code>
                                    </td>
                                </tr>


                                    <tr>
                                        <td class="col-md-4">
                                            <i>Type : </i>        <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/function" target="_blank" >function</a></code>

                                        </td>
                                    </tr>

                                    <tr>
                                        <td class="col-md-4">
                                            <i>Optional</i>
                                        </td>
                                    </tr>




                        </tbody>
                    </table>
                    <table class="table table-sm table-bordered">
                        <tbody>
                                <tr>
                                    <td class="col-md-4">
                                        <a name="voice_stop"></a>
                                        <span class="name "><b>voice_stop</b>
                                            <a href="#voice_stop">
                                                <span class="icon ion-ios-link"></span>
                                            </a>
                                        </span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="col-md-4">
                                        <code>voice_stop:         <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/function" target="_blank" >function</a></code>
</code>
                                    </td>
                                </tr>


                                    <tr>
                                        <td class="col-md-4">
                                            <i>Type : </i>        <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/function" target="_blank" >function</a></code>

                                        </td>
                                    </tr>

                                    <tr>
                                        <td class="col-md-4">
                                            <i>Optional</i>
                                        </td>
                                    </tr>




                        </tbody>
                    </table>
                    <table class="table table-sm table-bordered">
                        <tbody>
                                <tr>
                                    <td class="col-md-4">
                                        <a name="voice_stop_delay"></a>
                                        <span class="name "><b>voice_stop_delay</b>
                                            <a href="#voice_stop_delay">
                                                <span class="icon ion-ios-link"></span>
                                            </a>
                                        </span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="col-md-4">
                                        <code>voice_stop_delay:         <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/number" target="_blank" >number</a></code>
</code>
                                    </td>
                                </tr>


                                    <tr>
                                        <td class="col-md-4">
                                            <i>Type : </i>        <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/number" target="_blank" >number</a></code>

                                        </td>
                                    </tr>

                                    <tr>
                                        <td class="col-md-4">
                                            <i>Optional</i>
                                        </td>
                                    </tr>




                        </tbody>
                    </table>
                    <table class="table table-sm table-bordered">
                        <tbody>
                                <tr>
                                    <td class="col-md-4">
                                        <a name="voice_timeout"></a>
                                        <span class="name "><b>voice_timeout</b>
                                            <a href="#voice_timeout">
                                                <span class="icon ion-ios-link"></span>
                                            </a>
                                        </span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="col-md-4">
                                        <code>voice_timeout:         <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/number" target="_blank" >number</a></code>
</code>
                                    </td>
                                </tr>


                                    <tr>
                                        <td class="col-md-4">
                                            <i>Type : </i>        <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/number" target="_blank" >number</a></code>

                                        </td>
                                    </tr>

                                    <tr>
                                        <td class="col-md-4">
                                            <i>Optional</i>
                                        </td>
                                    </tr>




                        </tbody>
                    </table>
                    <table class="table table-sm table-bordered">
                        <tbody>
                                <tr>
                                    <td class="col-md-4">
                                        <a name="voice_timeout_callback"></a>
                                        <span class="name "><b>voice_timeout_callback</b>
                                            <a href="#voice_timeout_callback">
                                                <span class="icon ion-ios-link"></span>
                                            </a>
                                        </span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="col-md-4">
                                        <code>voice_timeout_callback:         <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/function" target="_blank" >function</a></code>
</code>
                                    </td>
                                </tr>


                                    <tr>
                                        <td class="col-md-4">
                                            <i>Type : </i>        <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/function" target="_blank" >function</a></code>

                                        </td>
                                    </tr>

                                    <tr>
                                        <td class="col-md-4">
                                            <i>Optional</i>
                                        </td>
                                    </tr>




                        </tbody>
                    </table>
            </section>
    </div>


    <div class="tab-pane fade  tab-source-code" id="source">
        <pre class="line-numbers compodoc-sourcecode"><code class="language-typescript">interface VADOptions {
    fftSize?: number;
    bufferLen?: number;
    voice_stop?: () &#x3D;&gt; void;
    voice_start?: () &#x3D;&gt; void;
    smoothingTimeConstant?: number;
    energy_offset?: number;
    energy_threshold_ratio_pos?: number;
    energy_threshold_ratio_neg?: number;
    energy_integration?: number;
    filter?: { f: number; v: number }[];
    source: AudioNode | null;
    context?: AudioContext | null;
    voice_stop_delay?: number;
    voice_timeout?: number;
    voice_timeout_callback?: () &#x3D;&gt; void;
}

class VAD {
    private options: VADOptions;
    private hertzPerBin: number;
    private iterationFrequency: number;
    private iterationPeriod: number;
    private filter: number[] &#x3D; [];
    private ready &#x3D; false;
    private vadState &#x3D; false;
    private energy &#x3D; 0;
    private energy_offset: number;
    private energy_threshold_pos: number;
    private energy_threshold_neg: number;
    private voiceTrend &#x3D; 0;
    private readonly voiceTrendMax &#x3D; 10;
    private readonly voiceTrendMin &#x3D; -10;
    private readonly voiceTrendStart &#x3D; 5;
    private readonly voiceTrendEnd &#x3D; -5;
    private analyser: AnalyserNode;
    private floatFrequencyData: Float32Array;
    private floatFrequencyDataLinear: Float32Array;
    private scriptProcessorNode: ScriptProcessorNode;
    private voiceStopTimeout: any &#x3D; null;
    private voice_timeout: number | null &#x3D; null;
    private voice_timeout_callback: (() &#x3D;&gt; void) | null &#x3D; null;
    private voice_timeoutId: any &#x3D; null;

    constructor(options: VADOptions) {
        const defaultOptions: VADOptions &#x3D; {
            fftSize: 512,
            bufferLen: 512,
            voice_stop: () &#x3D;&gt; {},
            voice_start: () &#x3D;&gt; {},
            smoothingTimeConstant: 0.99,
            energy_offset: 1e-8,
            energy_threshold_ratio_pos: 2,
            energy_threshold_ratio_neg: 0.5,
            energy_integration: 1,
            filter: [
                { f: 200, v: 0 },
                { f: 2000, v: 1 },
            ],
            source: null,
            context: null,
            voice_stop_delay: 1000,
        };

        this.options &#x3D; { ...defaultOptions, ...options };

        if (!this.options.source) throw new Error(&#x27;The options must specify a MediaStreamAudioSourceNode.&#x27;);
        this.options.context &#x3D; this.options.source.context as AudioContext;

        this.hertzPerBin &#x3D; this.options.context.sampleRate / this.options.fftSize!;
        this.iterationFrequency &#x3D; this.options.context.sampleRate / this.options.bufferLen!;
        this.iterationPeriod &#x3D; 1 / this.iterationFrequency;

        this.setFilter(this.options.filter!);

        this.energy_offset &#x3D; this.options.energy_offset!;
        this.energy_threshold_pos &#x3D; this.energy_offset * this.options.energy_threshold_ratio_pos!;
        this.energy_threshold_neg &#x3D; this.energy_offset * this.options.energy_threshold_ratio_neg!;

        this.analyser &#x3D; this.options.context.createAnalyser();
        this.analyser.smoothingTimeConstant &#x3D; this.options.smoothingTimeConstant!;
        this.analyser.fftSize &#x3D; this.options.fftSize!;

        this.floatFrequencyData &#x3D; new Float32Array(this.analyser.frequencyBinCount);
        this.floatFrequencyDataLinear &#x3D; new Float32Array(this.floatFrequencyData.length);

        this.options.source.connect(this.analyser);

        this.scriptProcessorNode &#x3D; this.options.context.createScriptProcessor(this.options.bufferLen!, 1, 1);
        this.scriptProcessorNode.connect(this.options.context.destination);

        this.scriptProcessorNode.onaudioprocess &#x3D; event &#x3D;&gt; {
            this.analyser.getFloatFrequencyData(this.floatFrequencyData);
            this.update();
            this.monitor();
        };

        this.options.source.connect(this.scriptProcessorNode);

        if (options.voice_timeout &amp;&amp; options.voice_timeout_callback) {
            this.voice_timeout &#x3D; options.voice_timeout;
            this.voice_timeout_callback &#x3D; options.voice_timeout_callback;
        }
    }

    private setFilter(shape: { f: number; v: number }[]): void {
        for (let i &#x3D; 0, iLen &#x3D; this.options.fftSize! / 2; i &lt; iLen; i++) {
            this.filter[i] &#x3D; 0;
            for (const shapeItem of shape) {
                if (i * this.hertzPerBin &lt; shapeItem.f) {
                    this.filter[i] &#x3D; shapeItem.v;
                    break;
                }
            }
        }
    }

    private update(): void {
        const fft &#x3D; this.floatFrequencyData;
        for (let i &#x3D; 0, iLen &#x3D; fft.length; i &lt; iLen; i++) {
            this.floatFrequencyDataLinear[i] &#x3D; Math.pow(10, fft[i] / 10);
        }
        this.ready &#x3D; false;
    }

    private getEnergy(): number {
        if (this.ready) {
            return this.energy;
        }
        let energy &#x3D; 0;
        const fft &#x3D; this.floatFrequencyDataLinear;
        for (let i &#x3D; 0, iLen &#x3D; fft.length; i &lt; iLen; i++) {
            energy +&#x3D; this.filter[i] * fft[i] * fft[i];
        }
        this.energy &#x3D; energy;
        this.ready &#x3D; true;
        return energy;
    }

    private monitor(): number {
        const energy &#x3D; this.getEnergy();
        const signal &#x3D; energy - this.energy_offset;

        if (signal &gt; this.energy_threshold_pos) {
            this.voiceTrend &#x3D; this.voiceTrend + 1 &gt; this.voiceTrendMax ? this.voiceTrendMax : this.voiceTrend + 1;
        } else if (signal &lt; -this.energy_threshold_neg) {
            this.voiceTrend &#x3D; this.voiceTrend - 1 &lt; this.voiceTrendMin ? this.voiceTrendMin : this.voiceTrend - 1;
        } else {
            if (this.voiceTrend &gt; 0) {
                this.voiceTrend--;
            } else if (this.voiceTrend &lt; 0) {
                this.voiceTrend++;
            }
        }

        let start &#x3D; false,
            end &#x3D; false;
        if (this.voiceTrend &gt; this.voiceTrendStart) {
            start &#x3D; true;
        } else if (this.voiceTrend &lt; this.voiceTrendEnd) {
            end &#x3D; true;
        }

        const integration &#x3D; signal * this.iterationPeriod * this.options.energy_integration!;
        if (integration &gt; 0 || !end) {
            this.energy_offset +&#x3D; integration;
        } else {
            this.energy_offset +&#x3D; integration * 10;
        }
        this.energy_offset &#x3D; this.energy_offset &lt; 0 ? 0 : this.energy_offset;
        this.energy_threshold_pos &#x3D; this.energy_offset * this.options.energy_threshold_ratio_pos!;
        this.energy_threshold_neg &#x3D; this.energy_offset * this.options.energy_threshold_ratio_neg!;

        if (start &amp;&amp; !this.vadState) {
            this.vadState &#x3D; true;
            this.options.voice_start!();
            if (this.voiceStopTimeout) {
                clearTimeout(this.voiceStopTimeout);
            }
        }
        if (end &amp;&amp; this.vadState) {
            this.vadState &#x3D; false;
            if (this.options.voice_stop_delay) {
                this.delayedVoiceStop();
            } else {
                this.options.voice_stop!();
            }
        }

        if (start) {
            clearTimeout(this.voice_timeoutId);
        }

        if (end &amp;&amp; !this.voice_timeoutId) {
            this.resetVoice_timeout();
        }

        return signal;
    }

    private delayedVoiceStop(): void {
        // Si ya existe un temporizador, lo cancelamos
        if (this.voiceStopTimeout) {
            clearTimeout(this.voiceStopTimeout);
        }
    
        // Verificamos si hay actividad de voz antes de proceder
        if (this.vadState) {
            // Si aún hay voz activa, cancelamos la detención y reiniciamos el temporizador
            this.voiceStopTimeout &#x3D; setTimeout(() &#x3D;&gt; {
                if (!this.vadState) {
                    this.options.voice_stop!();
                }
            }, this.options.voice_stop_delay!);
        } else {
            // Si no hay voz activa, proceder con el detener
            this.voiceStopTimeout &#x3D; setTimeout(() &#x3D;&gt; {
                if (!this.vadState) {
                    this.options.voice_stop!();
                }
            }, this.options.voice_stop_delay!);
        }
    }
    

    private resetVoice_timeout(): void {
        if (this.voice_timeout &amp;&amp; this.voice_timeout_callback) {
            clearTimeout(this.voice_timeoutId);
            this.voice_timeoutId &#x3D; setTimeout(() &#x3D;&gt; {
                this.voice_timeout_callback!();
            }, this.voice_timeout);
        }
    }

    public isVoiceActive(): boolean {
        return this.vadState;
      }
}

export default VAD;
</code></pre>
    </div>
</div>








                   </div><div class="search-results">
    <div class="has-results">
        <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
        <ul class="search-results-list"></ul>
    </div>
    <div class="no-results">
        <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
    </div>
</div>
</div>
               <!-- END CONTENT -->
           </div>
       </div>

          <label class="dark-mode-switch">
               <input type="checkbox">
               <span class="slider">
                    <svg class="slider-icon" viewBox="0 0 24 24" fill="none" height="20" stroke="#000" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" width="20" xmlns="http://www.w3.org/2000/svg">
                    <path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"></path>
                    </svg>
               </span>
          </label>

       <script>
            var COMPODOC_CURRENT_PAGE_DEPTH = 1;
            var COMPODOC_CURRENT_PAGE_CONTEXT = 'interface';
            var COMPODOC_CURRENT_PAGE_URL = 'VADOptions.html';
            var MAX_SEARCH_RESULTS = 15;
       </script>

       <script>
               $darkModeToggleSwitchers = document.querySelectorAll('.dark-mode-switch input');
               checkToggle(darkModeState);
               if ($darkModeToggleSwitchers.length > 0) {
                    for (var i = 0; i < $darkModeToggleSwitchers.length; i++) {
                         $darkModeToggleSwitchers[i].addEventListener('change', function (event) {
                              darkModeState = !darkModeState;
                              toggleDarkMode(darkModeState);
                         });
                    }
               }
          </script>

       <script src="../js/libs/custom-elements.min.js"></script>
       <script src="../js/libs/lit-html.js"></script>

       <script src="../js/menu-wc.js" defer></script>
       <script nomodule src="../js/menu-wc_es5.js" defer></script>

       <script src="../js/libs/bootstrap-native.js"></script>

       <script src="../js/libs/es6-shim.min.js"></script>
       <script src="../js/libs/EventDispatcher.js"></script>
       <script src="../js/libs/promise.min.js"></script>

       <script src="../js/compodoc.js"></script>

       <script src="../js/tabs.js"></script>
       <script src="../js/menu.js"></script>
       <script src="../js/libs/clipboard.min.js"></script>
       <script src="../js/libs/prism.js"></script>
       <script src="../js/sourceCode.js"></script>
          <script src="../js/search/search.js"></script>
          <script src="../js/search/lunr.min.js"></script>
          <script src="../js/search/search-lunr.js"></script>
          <script src="../js/search/search_index.js"></script>
       <script src="../js/lazy-load-graphs.js"></script>


    </body>
</html>
